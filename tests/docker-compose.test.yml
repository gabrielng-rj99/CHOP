version: "3.8"

services:
    postgres_test:
        image: postgres:16-alpine
        container_name: chop_test_db
        environment:
            POSTGRES_USER: test_user
            POSTGRES_PASSWORD: test_password
            POSTGRES_DB: contracts_test
        ports:
            - "65432:5432"
        volumes:
            - ../backend/database/schema:/docker-entrypoint-initdb.d:ro
            - postgres_test_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U test_user -d contracts_test"]
            interval: 5s
            timeout: 5s
            retries: 10
        networks:
            - test_network

    backend_test:
        build:
            context: ..
            dockerfile: deploy/docker/Dockerfile.backend
            args:
                GO_VERSION: "1.25"
        container_name: chop_test_backend
        environment:
            DB_HOST: postgres_test
            DB_PORT: 5432
            DB_USER: test_user
            DB_PASSWORD: test_password
            DB_NAME: contracts_test
            DB_SSL_MODE: disable
            API_PORT: 3000
            LOG_FILE: /app/logs/backend.log
            JWT_SECRET: test_jwt_secret_key_for_testing_only_do_not_use_in_production
            JWT_EXPIRATION_TIME: 3600
            JWT_REFRESH_EXPIRATION_TIME: 10080
            PASSWORD_MIN_LENGTH: 16
            PASSWORD_REQUIRE_UPPERCASE: "true"
            PASSWORD_REQUIRE_LOWERCASE: "true"
            PASSWORD_REQUIRE_NUMBERS: "true"
            PASSWORD_REQUIRE_SPECIAL: "true"
            MAX_FAILED_ATTEMPTS: 5
            LOCKOUT_DURATION: 15m
            LOCK_LEVELS: 3
            LOCK_LEVEL_1_ATTEMPTS: 3
            LOCK_LEVEL_1_DURATION: 5m
            LOCK_LEVEL_2_ATTEMPTS: 5
            LOCK_LEVEL_2_DURATION: 15m
            LOCK_LEVEL_3_ATTEMPTS: 10
            LOCK_LEVEL_3_DURATION: 60m
            GIN_MODE: release
            LOG_LEVEL: info
            RATE_LIMIT: 100
            RATE_BURST: 200
        ports:
            - "63000:3000"
        volumes:
            - ../app/tests/logs:/app/logs
        depends_on:
            postgres_test:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 30s
        networks:
            test_network:
                aliases:
                    - backend
        restart: unless-stopped

    frontend_test:
        build:
            context: ..
            dockerfile: deploy/docker/Dockerfile.frontend
            args:
                VITE_API_URL: http://localhost:63000
                NODE_VERSION: "24"
        container_name: chop_test_frontend
        environment:
            VITE_API_URL: http://localhost:63000
            SSL_DOMAIN: ""
        ports:
            - "65080:80"
        depends_on:
            backend_test:
                condition: service_healthy
        networks:
            - test_network
        restart: unless-stopped

    # Test runner service (optional - can be used to run tests inside container)
    test_runner:
        image: python:3.11-slim
        container_name: chop_test_runner
        working_dir: /tests
        volumes:
            - .:/tests
            - ../backend:/backend:ro
        environment:
            TEST_API_URL: http://backend_test:3000
            TEST_FRONTEND_URL: http://frontend_test:80
            DB_HOST: postgres_test
            DB_PORT: 5432
            DB_USER: test_user
            DB_PASSWORD: test_password
            DB_NAME: contracts_test
            JWT_SECRET: test_jwt_secret_key_for_testing_only_do_not_use_in_production
        depends_on:
            backend_test:
                condition: service_healthy
        networks:
            - test_network
        command: >
            sh -c "
              pip install -r requirements.txt &&
              pytest -v --tb=short --html=test_reports/report.html --self-contained-html
            "
        profiles:
            - test

volumes:
    postgres_test_data:
        name: chop_test_postgres_data

networks:
    test_network:
        name: chop_test_network
        driver: bridge
