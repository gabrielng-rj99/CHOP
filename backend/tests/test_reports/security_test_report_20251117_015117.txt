============================================================================
RELAT√ìRIO DE TESTES DE SEGURAN√áA
Contract Manager - Backend
============================================================================

Data/Hora: 2025-11-17 01:51:17
Ambiente: Testes Automatizados
Banco de Dados: PostgreSQL 16 (porta 65432)


============================================================================
INICIANDO TESTES DE SEGURAN√áA
============================================================================


============================================================================
VERIFICA√á√ÉO DE DEPEND√äNCIAS
============================================================================

[0;32m[‚úì][0m Docker encontrado: Docker version 28.5.2, build ecc694264d
[0;32m[‚úì][0m Docker Compose encontrado: Docker Compose version 2.40.3
[0;32m[‚úì][0m Go encontrado: go version go1.25.4 linux/amd64

============================================================================
INICIANDO BANCO DE DADOS DE TESTE
============================================================================

[0;34m[INFO][0m Subindo container PostgreSQL...
[0;32m[‚úì][0m Container iniciado
[0;34m[INFO][0m Aguardando banco de dados ficar pronto...
....[0;32m[‚úì][0m Banco de dados est√° pronto!

============================================================================
VERIFICANDO SCHEMA DO BANCO
============================================================================

[0;34m[INFO][0m Verificando se schema foi aplicado...
[0;32m[‚úì][0m Tabela 'users' encontrada
[0;32m[‚úì][0m Tabela 'clients' encontrada
[0;32m[‚úì][0m Tabela 'categories' encontrada
[0;32m[‚úì][0m Tabela 'lines' encontrada
[0;32m[‚úì][0m Tabela 'contracts' encontrada
[0;32m[‚úì][0m Tabela 'audit_logs' encontrada
[0;32m[‚úì][0m Tabela 'dependents' encontrada
[0;32m[‚úì][0m Schema verificado com sucesso

============================================================================
EXECUTANDO TESTES DE SEGURAN√áA
============================================================================

[0;34m[INFO][0m Executando suite completa de testes...
[0;34m[INFO][0m Database URL: postgres://test_user:test_password@localhost:65432/contracts_test?sslmode=disable

=== RUN   TestDatabaseConnection
    helpers_test.go:202: ‚úì Todas as tabelas do schema existem
--- PASS: TestDatabaseConnection (0.01s)
=== RUN   TestDatabasePopulation
    helpers_test.go:252: ‚úì Banco populado: 6 usu√°rios, 3 clientes, 2 categorias
--- PASS: TestDatabasePopulation (0.42s)
=== RUN   TestRealServerIntegration
=== RUN   TestRealServerIntegration/Health_endpoint_deve_responder
    helpers_test.go:280: ‚úì Servidor real respondendo corretamente
=== RUN   TestRealServerIntegration/Login_com_servidor_real_deve_funcionar
    helpers_test.go:68: Token n√£o retornado no login
--- FAIL: TestRealServerIntegration (0.48s)
    --- PASS: TestRealServerIntegration/Health_endpoint_deve_responder (0.00s)
    --- FAIL: TestRealServerIntegration/Login_com_servidor_real_deve_funcionar (0.07s)
=== RUN   TestAuthenticationFlows
=== RUN   TestAuthenticationFlows/Login_sem_credenciais_deve_falhar
    security_auth_flows_test.go:30: ‚úì Login sem credenciais rejeitado corretamente
=== RUN   TestAuthenticationFlows/Login_com_username_vazio_deve_falhar
    helpers_test.go:152: Username vazio deve ser rejeitado: Esperado status 400, obteve 401. Body: {"error":"Invalid credentials"}
=== RUN   TestAuthenticationFlows/Login_com_senha_vazia_deve_falhar
    helpers_test.go:152: Senha vazia deve ser rejeitada: Esperado status 400, obteve 401. Body: {"error":"Invalid credentials"}
=== RUN   TestAuthenticationFlows/Login_com_credenciais_v√°lidas_deve_retornar_token
    helpers_test.go:68: Token n√£o retornado no login
=== RUN   TestAuthenticationFlows/Login_com_senha_incorreta_deve_falhar
=== RUN   TestAuthenticationFlows/Login_com_usu√°rio_inexistente_deve_falhar
Erro no Scan da autentica√ß√£o: sql: no rows in result set
    security_auth_flows_test.go:107: ‚úì Mensagem de erro gen√©rica (n√£o revela se usu√°rio existe)
=== RUN   TestAuthenticationFlows/M√∫ltiplas_tentativas_de_login_falhadas_devem_incrementar_contador
    security_auth_flows_test.go:137: ‚úì Contador de tentativas falhadas funcionando: 0 -> 3
=== RUN   TestAuthenticationFlows/Conta_bloqueada_n√£o_deve_permitir_login
    security_auth_flows_test.go:157: FALHA: Conta bloqueada conseguiu fazer login!
=== RUN   TestAuthenticationFlows/Token_v√°lido_deve_permitir_acesso_a_endpoints_protegidos
    helpers_test.go:68: Token n√£o retornado no login
=== RUN   TestAuthenticationFlows/Requisi√ß√£o_sem_token_deve_ser_rejeitada
2025/11/17 01:51:25 Requisi√ß√£o sem token para GET /api/users
    security_auth_flows_test.go:195: ‚úì Prote√ß√£o de endpoints sem token funcionando
=== RUN   TestAuthenticationFlows/Token_com_formato_inv√°lido_deve_ser_rejeitado
2025/11/17 01:51:25 Token inv√°lido ou expirado para GET /api/users: token inv√°lido: token is malformed: token contains an invalid number of segments
2025/11/17 01:51:25 Token inv√°lido ou expirado para GET /api/users: token inv√°lido: token is malformed: token contains an invalid number of segments
2025/11/17 01:51:25 Requisi√ß√£o sem token para GET /api/users
2025/11/17 01:51:25 Token inv√°lido ou expirado para GET /api/users: token inv√°lido: token is malformed: token contains an invalid number of segments
    security_auth_flows_test.go:223: ‚úì Tokens inv√°lidos rejeitados corretamente
--- FAIL: TestAuthenticationFlows (1.27s)
    --- PASS: TestAuthenticationFlows/Login_sem_credenciais_deve_falhar (0.00s)
    --- FAIL: TestAuthenticationFlows/Login_com_username_vazio_deve_falhar (0.00s)
    --- FAIL: TestAuthenticationFlows/Login_com_senha_vazia_deve_falhar (0.00s)
    --- FAIL: TestAuthenticationFlows/Login_com_credenciais_v√°lidas_deve_retornar_token (0.07s)
    --- PASS: TestAuthenticationFlows/Login_com_senha_incorreta_deve_falhar (0.06s)
    --- PASS: TestAuthenticationFlows/Login_com_usu√°rio_inexistente_deve_falhar (0.00s)
    --- PASS: TestAuthenticationFlows/M√∫ltiplas_tentativas_de_login_falhadas_devem_incrementar_contador (0.57s)
    --- FAIL: TestAuthenticationFlows/Conta_bloqueada_n√£o_deve_permitir_login (0.07s)
    --- FAIL: TestAuthenticationFlows/Token_v√°lido_deve_permitir_acesso_a_endpoints_protegidos (0.07s)
    --- PASS: TestAuthenticationFlows/Requisi√ß√£o_sem_token_deve_ser_rejeitada (0.00s)
    --- PASS: TestAuthenticationFlows/Token_com_formato_inv√°lido_deve_ser_rejeitado (0.00s)
=== RUN   TestSessionManagement
=== RUN   TestSessionManagement/M√∫ltiplos_logins_devem_gerar_tokens_diferentes
    helpers_test.go:68: Token n√£o retornado no login
=== RUN   TestSessionManagement/Token_de_usu√°rio_diferente_n√£o_deve_dar_acesso
    helpers_test.go:68: Token n√£o retornado no login
--- FAIL: TestSessionManagement (0.55s)
    --- FAIL: TestSessionManagement/M√∫ltiplos_logins_devem_gerar_tokens_diferentes (0.07s)
    --- FAIL: TestSessionManagement/Token_de_usu√°rio_diferente_n√£o_deve_dar_acesso (0.06s)
=== RUN   TestAuthenticationEdgeCases
=== RUN   TestAuthenticationEdgeCases/Login_com_JSON_malformado_deve_falhar_gracefully
    security_auth_flows_test.go:306: ‚úì JSON malformado tratado corretamente sem vazar stack trace
=== RUN   TestAuthenticationEdgeCases/Login_com_Content-Type_incorreto
    security_auth_flows_test.go:323: ‚úì Content-Type validation funcionando
=== RUN   TestAuthenticationEdgeCases/Login_com_m√©todo_HTTP_incorreto_deve_falhar
=== RUN   TestAuthenticationEdgeCases/Campos_extras_no_login_devem_ser_ignorados
    security_auth_flows_test.go:357: ‚úì Login aceito, mas campos extras devem ser ignorados
--- PASS: TestAuthenticationEdgeCases (0.48s)
    --- PASS: TestAuthenticationEdgeCases/Login_com_JSON_malformado_deve_falhar_gracefully (0.00s)
    --- PASS: TestAuthenticationEdgeCases/Login_com_Content-Type_incorreto (0.00s)
    --- PASS: TestAuthenticationEdgeCases/Login_com_m√©todo_HTTP_incorreto_deve_falhar (0.00s)
    --- PASS: TestAuthenticationEdgeCases/Campos_extras_no_login_devem_ser_ignorados (0.07s)
=== RUN   TestDataLeakage
    helpers_test.go:68: Token n√£o retornado no login
--- FAIL: TestDataLeakage (0.48s)
=== RUN   TestSensitiveFieldsInDatabase
=== RUN   TestSensitiveFieldsInDatabase/Senhas_devem_estar_hasheadas_no_banco
=== RUN   TestSensitiveFieldsInDatabase/Auth_secret_deve_existir_e_ser_√∫nico_por_usu√°rio
=== RUN   TestSensitiveFieldsInDatabase/Nenhum_campo_sens√≠vel_deve_ter_valor_padr√£o_previs√≠vel
--- PASS: TestSensitiveFieldsInDatabase (0.41s)
    --- PASS: TestSensitiveFieldsInDatabase/Senhas_devem_estar_hasheadas_no_banco (0.00s)
    --- PASS: TestSensitiveFieldsInDatabase/Auth_secret_deve_existir_e_ser_√∫nico_por_usu√°rio (0.00s)
    --- PASS: TestSensitiveFieldsInDatabase/Nenhum_campo_sens√≠vel_deve_ter_valor_padr√£o_previs√≠vel (0.00s)
=== RUN   TestAPIResponseStructure
    helpers_test.go:68: Token n√£o retornado no login
--- FAIL: TestAPIResponseStructure (0.48s)
=== RUN   TestPasswordHashStrength
=== RUN   TestPasswordHashStrength/Password_hashes_devem_usar_bcrypt_com_custo_adequado
--- PASS: TestPasswordHashStrength (0.42s)
    --- PASS: TestPasswordHashStrength/Password_hashes_devem_usar_bcrypt_com_custo_adequado (0.00s)
=== RUN   TestTimingAttackPrevention
=== RUN   TestTimingAttackPrevention/Login_deve_ter_tempo_constante_independente_de_usu√°rio_existir
    security_data_leak_test.go:444: ‚úì bcrypt fornece prote√ß√£o contra timing attacks
    security_data_leak_test.go:445: ‚úì Todas compara√ß√µes de senha devem usar bcrypt.CompareHashAndPassword
--- PASS: TestTimingAttackPrevention (0.42s)
    --- PASS: TestTimingAttackPrevention/Login_deve_ter_tempo_constante_independente_de_usu√°rio_existir (0.00s)
=== RUN   TestDataLeakageSummary
=== RUN   TestDataLeakageSummary/Resumo_de_Prote√ß√µes_contra_Vazamento_de_Dados
    security_data_leak_test.go:464: 
        ======================================================================
    security_data_leak_test.go:465: PROTE√á√ïES CONTRA VAZAMENTO DE DADOS IMPLEMENTADAS
    security_data_leak_test.go:466: ======================================================================
    security_data_leak_test.go:468: ‚úì password_hash NUNCA vaza em respostas da API
    security_data_leak_test.go:468: ‚úì auth_secret NUNCA vaza em respostas da API
    security_data_leak_test.go:468: ‚úì Senhas s√£o hasheadas com bcrypt (custo >= 10)
    security_data_leak_test.go:468: ‚úì Stack traces n√£o vazam em erros
    security_data_leak_test.go:468: ‚úì Mensagens de erro s√£o gen√©ricas
    security_data_leak_test.go:468: ‚úì Erros de login n√£o revelam se usu√°rio existe
    security_data_leak_test.go:468: ‚úì Detalhes internos do DB n√£o vazam
    security_data_leak_test.go:468: ‚úì Auth secrets s√£o √∫nicos por usu√°rio
    security_data_leak_test.go:468: ‚úì Nenhum valor padr√£o previs√≠vel
    security_data_leak_test.go:468: ‚úì bcrypt protege contra timing attacks
    security_data_leak_test.go:470: ======================================================================
--- PASS: TestDataLeakageSummary (0.00s)
    --- PASS: TestDataLeakageSummary/Resumo_de_Prote√ß√µes_contra_Vazamento_de_Dados (0.00s)
=== RUN   TestPasswordSecurity
=== RUN   TestPasswordSecurity/Senha_deve_ser_hasheada_no_banco_de_dados
    security_password_test.go:39: ‚úì Nenhuma senha em plain text no banco
=== RUN   TestPasswordSecurity/Todos_os_hashes_devem_ser_bcrypt_v√°lidos
    security_password_test.go:74: ‚úì Todos os hashes s√£o bcrypt v√°lidos
=== RUN   TestPasswordSecurity/Altera√ß√£o_de_senha_deve_invalidar_token_antigo
    helpers_test.go:68: Token n√£o retornado no login
--- FAIL: TestPasswordSecurity (0.92s)
    --- PASS: TestPasswordSecurity/Senha_deve_ser_hasheada_no_banco_de_dados (0.00s)
    --- PASS: TestPasswordSecurity/Todos_os_hashes_devem_ser_bcrypt_v√°lidos (0.35s)
    --- FAIL: TestPasswordSecurity/Altera√ß√£o_de_senha_deve_invalidar_token_antigo (0.13s)
=== RUN   TestPasswordStrength
=== RUN   TestPasswordStrength/Bcrypt_cost_deve_ser_adequado_(>=_10)
    security_password_test.go:164: ‚úì Bcrypt cost adequado: 10
=== RUN   TestPasswordStrength/Criar_usu√°rio_com_senha_fraca_deve_funcionar_(mas_ser_hasheado)
    security_password_test.go:185: ‚úì Mesmo senhas fracas s√£o hasheadas (valida√ß√£o de for√ßa deve estar no frontend)
--- PASS: TestPasswordStrength (0.47s)
    --- PASS: TestPasswordStrength/Bcrypt_cost_deve_ser_adequado_(>=_10) (0.00s)
    --- PASS: TestPasswordStrength/Criar_usu√°rio_com_senha_fraca_deve_funcionar_(mas_ser_hasheado) (0.06s)
=== RUN   TestPasswordChangeFlows
=== RUN   TestPasswordChangeFlows/Tentativa_de_mudan√ßa_de_senha_sem_autentica√ß√£o_deve_falhar
2025/11/17 01:51:30 Requisi√ß√£o sem token para PUT /api/users/test_user
=== RUN   TestPasswordChangeFlows/Usu√°rio_n√£o_deve_poder_mudar_senha_de_outro_usu√°rio
    helpers_test.go:68: Token n√£o retornado no login
--- FAIL: TestPasswordChangeFlows (0.48s)
    --- PASS: TestPasswordChangeFlows/Tentativa_de_mudan√ßa_de_senha_sem_autentica√ß√£o_deve_falhar (0.00s)
    --- FAIL: TestPasswordChangeFlows/Usu√°rio_n√£o_deve_poder_mudar_senha_de_outro_usu√°rio (0.07s)
=== RUN   TestPasswordStorage
=== RUN   TestPasswordStorage/Password_hash_nunca_deve_vazar_em_responses
