# CHOP - Backend Makefile
# Located in: backend/Makefile
# Usage: make -f backend/Makefile <target>
# Or: cd backend && make <target>

.PHONY: help build rebuild run clean test fmt lint coverage

# Colors
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m

OUTPUT_DIR := ../app/dev/bin
BINARY_NAME := $(OUTPUT_DIR)/chop-backend-dev.bin
MAIN_PATH := ./main.go

help: ## Show backend build commands
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘$(NC)    CHOP - Backend Build & Development Tasks             $(BLUE)â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@echo "$(YELLOW)Build Commands:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)Configuration:$(NC)"
	@echo "  Language: Go 1.25.1+"
	@echo "  Main: $(MAIN_PATH)"
	@echo "  Binary: $(BINARY_NAME)"
	@echo ""

build: ## Build backend binary
	@echo "$(BLUE)ğŸ”¨ Building backend...$(NC)"
	@mkdir -p $(OUTPUT_DIR)
	@go build -o $(BINARY_NAME) $(MAIN_PATH)
	@echo "$(GREEN)âœ… Build complete: $(BINARY_NAME)$(NC)"

rebuild: clean build ## Clean and rebuild backend

run: build ## Build and run backend
	@echo "$(BLUE)ğŸš€ Running backend...$(NC)"
	@$(BINARY_NAME)

dev: ## Run backend in development mode with hot reload (requires air)
	@echo "$(BLUE)ğŸ”„ Running with hot reload...$(NC)"
	@air || (echo "$(YELLOW)Installing air...$(NC)" && go install github.com/cosmtrek/air@latest && air)

test: ## Run backend tests
	@echo "$(BLUE)ğŸ§ª Running backend tests...$(NC)"
	@go test -v -cover ./...

test-coverage: ## Run tests with coverage report
	@echo "$(BLUE)ğŸ“Š Running tests with coverage...$(NC)"
	@go test -v -coverprofile=coverage.out ./...
	@go tool cover -func=coverage.out | tail -n 1
	@echo "$(YELLOW)Generating HTML coverage report...$(NC)"
	@go tool cover -html=coverage.out -o coverage.html
	@echo "$(GREEN)âœ… Coverage report: coverage.html$(NC)"

fmt: ## Format Go code
	@echo "$(BLUE)ğŸ¨ Formatting code...$(NC)"
	@go fmt ./...
	@echo "$(GREEN)âœ… Code formatted$(NC)"

lint: ## Run Go linter
	@echo "$(BLUE)ğŸ” Running linter...$(NC)"
	@go vet ./...
	@echo "$(GREEN)âœ… Linting complete$(NC)"

clean: ## Clean build artifacts
	@echo "$(YELLOW)ğŸ§¹ Cleaning...$(NC)"
	@rm -f $(BINARY_NAME)
	@rm -f coverage.out coverage.html
	@go clean
	@echo "$(GREEN)âœ… Cleaned$(NC)"

deps: ## Download and tidy dependencies
	@echo "$(BLUE)ğŸ“¦ Managing dependencies...$(NC)"
	@go mod download
	@go mod tidy
	@echo "$(GREEN)âœ… Dependencies updated$(NC)"

mod-verify: ## Verify module integrity
	@echo "$(BLUE)ğŸ” Verifying modules...$(NC)"
	@go mod verify
	@echo "$(GREEN)âœ… Module verification passed$(NC)"

info: ## Show backend information
	@echo "$(BLUE)â„¹ï¸  Backend Information:$(NC)"
	@echo "  Go Version: $$(go version | awk '{print $$3}')"
	@echo "  Main: $(MAIN_PATH)"
	@echo "  Binary: $(BINARY_NAME)"
	@echo "  Module: $$(go list -m)"
	@echo ""

.DEFAULT_GOAL := help
.SILENT:
