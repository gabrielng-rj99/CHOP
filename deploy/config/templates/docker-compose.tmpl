# Docker Compose Template
# This file is used as a template by the Deploy Manager to generate the final docker-compose.yml
# It uses {{VARIABLE}} placeholders that are replaced based on docker.ini configuration
# Do not edit this file directly - modify docker.ini instead

services:
    postgres:
        image: postgres:16-alpine
        container_name: {{POSTGRES_CONTAINER}}
        environment:
            POSTGRES_USER: {{DB_USER}}
            POSTGRES_PASSWORD: {{DB_PASSWORD}}
            POSTGRES_DB: {{DB_NAME}}
{{POSTGRES_PORTS}}
        volumes:
            - {{POSTGRES_VOLUME}}:/var/lib/postgresql/data
            - ../../backend/database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U {{DB_USER}}"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - app-network
        restart: unless-stopped

    backend:
        build:
            context: ../../
            dockerfile: deploy/docker/backend/Dockerfile
        container_name: {{BACKEND_CONTAINER}}
        environment:
            # Server config
            SERVER_HOST: 0.0.0.0
            API_PORT: {{BACKEND_CONTAINER_PORT}}

            # Database config
            DB_HOST: postgres
            DB_PORT: {{DB_PORT}}
            DB_NAME: {{DB_NAME}}
            DB_USER: {{DB_USER}}
            DB_PASSWORD: {{DB_PASSWORD}}
            DB_SSLMODE: {{DB_SSLMODE}}
            DB_MAX_OPEN_CONNS: 25
            DB_MAX_IDLE_CONNS: 5
            DB_CONN_MAX_LIFETIME: 300

            # JWT config
            JWT_SECRET: {{JWT_SECRET}}
            JWT_EXPIRATION_TIME: {{JWT_EXPIRATION_TIME}}
            JWT_REFRESH_EXPIRATION_TIME: {{JWT_REFRESH_EXPIRATION_TIME}}
            JWT_ALGORITHM: {{JWT_ALGORITHM}}

            # CORS config
            CORS_ALLOWED_ORIGINS: http://localhost:{{FRONTEND_HOST_PORT}},http://localhost:5173,http://frontend
            CORS_ALLOWED_METHODS: GET,POST,PUT,DELETE,OPTIONS,PATCH
            CORS_ALLOWED_HEADERS: Content-Type,Authorization
            CORS_ALLOW_CREDENTIALS: true

            # App config
            APP_ENV: docker
            APP_VERSION: 1.0.0
            APP_NAME: Open-Generic-Hub

            # Logging config
            LOG_ENABLED: true
            LOG_LEVEL: info
            LOG_FORMAT: json
            LOG_FILE: logs/app.log

            # Paths
            SCHEMA_FILE: database/schema.sql
            MIGRATIONS_DIR: database/migrations
            LOGS_DIR: logs
{{BACKEND_PORTS}}
        depends_on:
            postgres:
                condition: service_healthy
        volumes:
            - ../../backend/database:/app/database:ro
            - backend_logs:/app/logs
        networks:
            - app-network
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://localhost:{{BACKEND_CONTAINER_PORT}}/health",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    frontend:
        build:
            context: ../../
            dockerfile: deploy/docker/frontend/Dockerfile
            args:
                VITE_API_URL: http://localhost:{{BACKEND_HOST_PORT}}
        container_name: {{FRONTEND_CONTAINER}}
        environment:
            NGINX_PORT: {{FRONTEND_CONTAINER_PORT}}
            BACKEND_URL: http://backend:{{BACKEND_CONTAINER_PORT}}
{{FRONTEND_PORTS}}
        depends_on:
            backend:
                condition: service_healthy
        networks:
            - app-network
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://127.0.0.1:{{FRONTEND_CONTAINER_PORT}}/health",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s

volumes:
    {{POSTGRES_VOLUME}}:
        driver: local
    backend_logs:
        driver: local

networks:
    app-network:
        driver: bridge
        name: {{NETWORK_NAME}}
