# Docker Compose Template
# This file is used as a template by the Deploy Manager to generate the final docker-compose.yml
# It uses VARIABLE placeholders that are replaced based on docker.ini configuration
# Do not edit this file directly - modify docker.ini instead

services:
    postgres:
        image: postgres:16-alpine
        container_name: opengeneric_postgres
        environment:
            POSTGRES_USER: appuser
            POSTGRES_PASSWORD: RvWcybZUhhjRvaWvggBB9_Dp-aG2gnU2lijwPBBM3FjWJh01u7-Ruue4KCsCBWNi
            POSTGRES_DB: appdb
        ports:
            - "5432:5432"

        volumes:
            - opengeneric_postgres_data:/var/lib/postgresql/data
            - ../../backend/database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U appuser"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - app-network
        restart: unless-stopped

    backend:
        build:
            context: ../../
            dockerfile: deploy/docker/backend/Dockerfile
        container_name: opengeneric_backend
        environment:
            # Server config
            SERVER_HOST: 0.0.0.0
            API_PORT: 3000

            # Database config
            DB_HOST: postgres
            DB_PORT: 5432
            DB_NAME: appdb
            DB_USER: appuser
            DB_PASSWORD: RvWcybZUhhjRvaWvggBB9_Dp-aG2gnU2lijwPBBM3FjWJh01u7-Ruue4KCsCBWNi
            DB_SSLMODE: disable
            DB_MAX_OPEN_CONNS: 25
            DB_MAX_IDLE_CONNS: 5
            DB_CONN_MAX_LIFETIME: 300

            # JWT config
            JWT_SECRET: 50JxmXKPDwgYG5dy_s35ow2emini3rtathqvZ252ov2rRUGY5xoPoJEjuJlgAh9X
            JWT_EXPIRATION_TIME: 60
            JWT_REFRESH_EXPIRATION_TIME: 10080
            JWT_ALGORITHM: HS256

            # CORS config
            CORS_ALLOWED_ORIGINS: http://localhost:8080,http://localhost:5173,http://frontend
            CORS_ALLOWED_METHODS: GET,POST,PUT,DELETE,OPTIONS,PATCH
            CORS_ALLOWED_HEADERS: Content-Type,Authorization
            CORS_ALLOW_CREDENTIALS: true

            # App config
            APP_ENV: docker
            APP_VERSION: 1.0.0
            APP_NAME: Open-Generic-Hub

            # Logging config
            LOG_ENABLED: true
            LOG_LEVEL: info
            LOG_FORMAT: json
            LOG_FILE: logs/app.log

            # Paths
            SCHEMA_FILE: database/schema.sql
            MIGRATIONS_DIR: database/migrations
            LOGS_DIR: logs
        ports:
            - "3000:3000"

        depends_on:
            postgres:
                condition: service_healthy
        volumes:
            - ../../backend/database:/app/database:ro
            - backend_logs:/app/logs
        networks:
            - app-network
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://localhost:3000/health",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    frontend:
        build:
            context: ../../
            dockerfile: deploy/docker/frontend/Dockerfile
            args:
                VITE_API_URL: http://localhost:3000
        container_name: opengeneric_frontend
        environment:
            NGINX_PORT: 80
            BACKEND_URL: http://backend:3000
        ports:
            - "8080:80"

        depends_on:
            backend:
                condition: service_healthy
        networks:
            - app-network
        restart: unless-stopped
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://127.0.0.1:80/health",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s

volumes:
    opengeneric_postgres_data:
        driver: local
    backend_logs:
        driver: local

networks:
    app-network:
        driver: bridge
        name: opengeneric-network
